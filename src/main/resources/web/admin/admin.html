<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>MCTrilhas | Painel de Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/adminlte.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
</head>
<body class="bg-body-tertiary">
    <div class="app-wrapper">
        <main class="app-main" style="margin-left: 0;">
            <div class="app-content-header">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="mb-0">Painel de Administração</h3>
                        </div>
                        <div class="col-sm-6">
                            <button id="logout-button" class="btn btn-danger float-end">
                                <i class="bi bi-box-arrow-right"></i> Sair
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="app-content">
                <div class="container-fluid">
                    <div class="card">
                        <div class="card-body">
                            <h1>Bem-vindo, Administrador!</h1>
                            <p>Esta é uma área protegida. Se você está vendo esta página, seu login foi bem-sucedido.</p>
                            <p>Futuramente, aqui teremos gráficos e ferramentas de gerenciamento do servidor.</p>
                        </div>
                    </div>
                    <!-- Card de Teste da API -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">Teste de API Protegida</h3>
                        </div>
                        <div class="card-body">
                            <p>Clique no botão abaixo para fazer uma requisição a um endpoint protegido. A requisição só funcionará se o seu token de sessão (JWT) for válido.</p>
                            <button id="test-api-btn" class="btn btn-info">Testar Endpoint</button>
                            <div class="mt-3">
                                <strong>Resultado:</strong>
                                <pre id="api-result" class="bg-dark text-white p-3 rounded" style="max-height: 300px; overflow-y: auto;">Aguardando teste...</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="./js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Protege a página, redirecionando para o login se não houver token
            protectPage();

            // Adiciona funcionalidade ao botão de logout
            document.getElementById('logout-button').addEventListener('click', () => logout());

            // Lógica para testar o endpoint protegido
            const testBtn = document.getElementById('test-api-btn');
            const resultEl = document.getElementById('api-result');

            testBtn.addEventListener('click', async () => {
                resultEl.textContent = 'Carregando...';
                try {
                    const response = await fetch('/api/v1/admin/status', {
                        method: 'GET',
                        headers: getAuthHeaders() // Função do auth.js que adiciona o 'Authorization: Bearer <token>'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        resultEl.textContent = JSON.stringify(data, null, 2);
                    } else {
                        // Se o token for inválido, a API retorna 401
                        resultEl.textContent = `Erro: ${data.error || response.statusText}`;
                        if (response.status === 401) {
                            resultEl.textContent += '\n\nToken inválido. Deslogando em 3 segundos...';
                            setTimeout(logout, 3000);
                        }
                    }
                } catch (error) {
                    resultEl.textContent = 'Erro de conexão ao tentar acessar a API.';
                }
            });
        });
    </script>
</body>
</html>